{"version":3,"file":"total.8e8d2f4ce7368412.hot-update.js","sources":["C:/Users/oneirocosm/Code/Repositories/oncemore/moondunk2025/src/browser/graphics/total.tsx","webpack/runtime/get_full_hash"],"sourcesContent":["import { useReplicant } from '@nodecg/react-hooks';\nimport { Donation } from '../../types/donation';\nimport React from \"react\";\nimport Countdown from \"react-countdown\";\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { render } from '../render';\nimport './css/style.css';\nimport totalBucket from \"./components/total-bucket.png\";\nimport Wave from \"react-wavify\";\nimport { useIncrementNumber } from './components/useIncrementNumber';\nimport Splash from './components/Splash';\n\nconst MOONSHOT_CORE_DARK = '#040328';\nconst MOONSHOT_EXTRA_LIGHT_BLUE = '#A8BDF0';\nconst MOONSHOT_CORE_YELLOW = '#FFEE83';\nconst MOONSHOT_EXTRA_GOLD = '#FFC022';\n\ntype WaterfallInfo = {\n    id: string;\n    top: number;\n    height: number;\n    expectedAmount: number\n}\n\nconst App = () => {\n  const [queuedDonations, _] = useReplicant<Array<Donation>>('queueddonations');\n  const [total, setTotal] = useReplicant<number>(\"total\", {bundle: \"nodecg-tiltify\"});\n  //const [total, setTotal] = useReplicant<number>(\"faketotal\");\n  const [overriddenTotal, setOverriddenTotal] = useReplicant<number>(\"overriddentotal\");\n  const [dispensing, setDispensing] = React.useState<Donation | undefined>(undefined);\n  const [delayedTotal, setDelayedTotal] = React.useState<number>(total ?? 0);\n  const totalDisplay = Math.floor(useIncrementNumber(delayedTotal ?? 0));\n  const [waterfallSegments, setWaterfallSegments] = React.useState<Array<WaterfallInfo>>([]);\n  const [trackingTotal, setTrackingTotal] = React.useState<number>(total ?? 0);\n\n  const combinedTotal: number = React.useMemo(() => {\n    return overriddenTotal || (total ?? 0); \n  }, [total, overriddenTotal])\n\n  // this can be buggy but it is necessary in a reset\n  React.useEffect(() => {\n    if (waterfallSegments.length == 0 && combinedTotal != undefined) {\n        setTrackingTotal(combinedTotal);\n        setDelayedTotal(combinedTotal);\n    }\n    if (combinedTotal != undefined && Math.abs(combinedTotal - delayedTotal) > 100) {\n        setTrackingTotal(combinedTotal);\n        setDelayedTotal(combinedTotal);\n    }\n  }, [waterfallSegments.length])\n\n  const yScaleFactor = React.useMemo(() => {\n    const target = nodecg.bundleConfig.MOONDUNK_TARGET ?? 2000;\n    const minScale = 1;\n    const maxScale = 41;\n    const amount = delayedTotal ?? 0;\n    const ratio = amount / target;\n    return Math.max(minScale, Math.min(maxScale, minScale*(1-ratio) + maxScale*ratio))\n\n  }, [delayedTotal])\n\n  React.useEffect(() => {\n    if (queuedDonations == undefined || queuedDonations.length == 0) {\n      setDispensing(undefined);\n      return;\n    }\n      setDispensing(queuedDonations[0]);\n    }, [queuedDonations]);\n\n  React.useEffect(() => {\n    if (dispensing == undefined) {\n        return;\n    };\n\n    const newSegment: WaterfallInfo = {\n        id: dispensing.id,\n        top: 68,\n        height: 0,\n        expectedAmount: trackingTotal + dispensing.amountDisplay,\n    };\n    setTrackingTotal((current) => current + dispensing.amountDisplay);\n\n\n    setWaterfallSegments((current) => [...current, newSegment])\n  }, [dispensing?.id])\n\n  const waveBottom = 45 + 22.5 * yScaleFactor;\n\n  React.useEffect(() => {\n    const timeout = setTimeout(() => {\n        setWaterfallSegments((current) => {\n            const newSegments = current.map((segment) => {\n                if (segment.id == dispensing?.id) {\n                    return {...segment, height: Math.min(segment.height + 2, 1012 - waveBottom)}\n                }\n                if (segment.top + segment.height < 1078 - waveBottom) {\n                    return {...segment, top: Math.max(0, segment.top + 2)}\n                }\n\n                const cyclesRemaining = Math.max(Math.floor(segment.height / 2), 1);\n                const difference = Math.max(0, segment.expectedAmount - delayedTotal);\n                const dAmount = difference / cyclesRemaining;\n                setDelayedTotal((current) => Math.min(current + dAmount, combinedTotal ??0))\n                return {\n                    ...segment,\n                    top: Math.max(0, segment.top + 2),\n                    height: Math.max(0, segment.height - 2),\n                }\n            }); \n            return newSegments.filter((segment) => segment.height != 0);\n    })\n    }, 5);\n\n    return () => clearTimeout(timeout);\n  }, [waterfallSegments, dispensing?.id])\n\n\n\n  return <div style={{\n      position: \"absolute\",\n      background: `url(${totalBucket})`,\n      width: 208,\n      height: 1080,\n      fontFamily: \"Exo2\",\n      color: MOONSHOT_CORE_YELLOW,\n      textShadow: `-2px -2px 0 ${MOONSHOT_CORE_DARK}, 2px -2px 0 ${MOONSHOT_CORE_DARK}, -2px 2px 0 ${MOONSHOT_CORE_DARK}, 2px 2px 0 ${MOONSHOT_CORE_DARK}`,\n      fontSize: \"26px\",\n    }}>\n        <div style={{\n            position: \"absolute\",\n            transformOrigin: \"bottom left\",\n            left: 90,\n            bottom: 45,\n            width: 100,\n            height: 22.5,\n            transform: `scaleY(${yScaleFactor})`,\n            backgroundColor: MOONSHOT_EXTRA_LIGHT_BLUE,\n            opacity: 0.9,\n            zIndex: -1,\n        }}/>\n        <div style={{\n            position: \"absolute\",\n            transformOrigin: \"bottom left\",\n            left: 90,\n            bottom: 45,\n            width: 100,\n            height: 22,\n            backgroundColor: MOONSHOT_EXTRA_LIGHT_BLUE,\n            opacity: 0.9,\n            zIndex: -1,\n        }}/>\n        <Wave fill={MOONSHOT_EXTRA_LIGHT_BLUE}\n          paused={false}\n          style={{\n            position: \"absolute\",\n            transformOrigin: \"bottom left\",\n            left: 90,\n            bottom: waveBottom,\n            width: 100,\n            height: 22.5,\n            transform: `scaleY(2)`,\n            opacity: 0.9,\n            zIndex: -1,\n          }}\n          options={{\n            height: 20,\n            amplitude: 10,\n            speed: 0.3,\n            points: 2,\n          }}\n        />\n        <Wave fill={MOONSHOT_EXTRA_LIGHT_BLUE}\n          paused={false}\n          style={{\n            position: \"absolute\",\n            transformOrigin: \"bottom left\",\n            left: 90,\n            bottom: waveBottom,\n            width: 100,\n            height: 22.5,\n            transform: `scaleY(2)`,\n            opacity: 0.9,\n            zIndex: -1,\n          }}\n          options={{\n            height: 20,\n            amplitude: 10,\n            speed: 0.6,\n            points: 1,\n          }}\n        />\n        <Wave fill={MOONSHOT_EXTRA_LIGHT_BLUE}\n          paused={false}\n          style={{\n            position: \"absolute\",\n            transformOrigin: \"bottom left\",\n            left: 90,\n            bottom: waveBottom,\n            width: 100,\n            height: 22.5,\n            transform: `scaleY(2)`,\n            opacity: 0.9,\n            zIndex: -1,\n          }}\n          options={{\n            height: 20,\n            amplitude: 10,\n            speed: 0.5,\n            points: 2,\n          }}\n        />\n        <span style={{\n            position: \"absolute\",\n            left: 125,\n            bottom: 54,\n        }}>$0</span>\n        <span style={{\n            position: \"absolute\",\n            left: 110,\n            bottom: 278,\n        }}>${Math.floor((nodecg.bundleConfig?.MOONDUNK_TARGET ?? 2000) / 4)}</span>\n        <span style={{\n            position: \"absolute\",\n            left: 103,\n            bottom: 502,\n        }}>${Math.floor((nodecg.bundleConfig?.MOONDUNK_TARGET ?? 2000) / 2)}</span>\n        <span style={{\n            position: \"absolute\",\n            left: 103,\n            bottom: 728,\n        }}>${Math.floor((nodecg.bundleConfig?.MOONDUNK_TARGET ?? 2000) * 3 / 4)}</span>\n        <span style={{\n            position: \"absolute\",\n            left: 95,\n            bottom: 952,\n        }}>${Math.floor(nodecg.bundleConfig?.MOONDUNK_TARGET ?? 2000)}+</span>\n        <span style={{\n            position: \"absolute\",\n            left: 106,\n            bottom: 1014,\n            fontSize: 34,\n            color: MOONSHOT_EXTRA_GOLD,\n        }}>${totalDisplay}</span>\n        {waterfallSegments.map((segmentInfo) => <div key={`waterfall-segment-${segmentInfo.id}`} style={{\n            position: \"absolute\",\n            background: MOONSHOT_EXTRA_LIGHT_BLUE,\n            width: 10,\n            height: segmentInfo.height,\n            top: segmentInfo.top,\n            left: 95,\n            zIndex: -1,\n            transformOrigin: \"top left\",\n        }}/>)}\n    </div>\n}\n\nrender(<App />);","__webpack_require__.h = () => (\"ad4eba59cb1f103f\")"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AAEA;AAGA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AASA;AAoMA;;AAnMA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAIA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;AAEA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;AAEA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;AAEA;AAAA;AACA;AACA;AACA;AACA;AAAA;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;;AAAA;AAAA;;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;;AAAA;AAAA;;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;;AAAA;AAAA;;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;;AAAA;AAAA;AAAA;;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;AAAA;AAAA;;;;;;;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AATA;;;;;;;;;;;AAWA;AAtOA;;AACA;AACA;AAEA;AAGA;;;AAPA;AAwOA;;;;;;;;;;;;;;;;;;;;;;;;AChQA"}