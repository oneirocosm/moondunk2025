{"version":3,"file":"index.js","sources":["webpack://moondunk2025/webpack/runtime/create_fake_namespace_object","webpack://moondunk2025/webpack/runtime/define_property_getters","webpack://moondunk2025/webpack/runtime/has_own_property","webpack://moondunk2025/webpack/runtime/make_namespace_object","webpack://moondunk2025/./src/extension/index.ts","webpack://moondunk2025/./src/extension/debug-tools.ts"],"sourcesContent":["var getProto = Object.getPrototypeOf ? (obj) => (Object.getPrototypeOf(obj)) : (obj) => (obj.__proto__);\nvar leafPrototypes;\n// create a fake namespace object\n// mode & 1: value is a module id, require it\n// mode & 2: merge all properties of value into the ns\n// mode & 4: return value when already ns object\n// mode & 16: return value when it's Promise-like\n// mode & 8|1: behave like require\n__webpack_require__.t = function(value, mode) {\n\tif(mode & 1) value = this(value);\n\tif(mode & 8) return value;\n\tif(typeof value === 'object' && value) {\n\t\tif((mode & 4) && value.__esModule) return value;\n\t\tif((mode & 16) && typeof value.then === 'function') return value;\n\t}\n\tvar ns = Object.create(null);\n  __webpack_require__.r(ns);\n\tvar def = {};\n\tleafPrototypes = leafPrototypes || [null, getProto({}), getProto([]), getProto(getProto)];\n\tfor(var current = mode & 2 && value; typeof current == 'object' && !~leafPrototypes.indexOf(current); current = getProto(current)) {\n\t\tObject.getOwnPropertyNames(current).forEach((key) => { def[key] = () => (value[key]) });\n\t}\n\tdef['default'] = () => (value);\n\t__webpack_require__.d(ns, def);\n\treturn ns;\n};","__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n        if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n            Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n        }\n    }\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import type NodeCG from 'nodecg/types';\nimport type {Donation} from \"../types/donation\";\nimport \"dotenv/config\";\nimport {Queue} from \"elegant-queue\";\nimport {randomUUID} from \"crypto\";\n\ninterface TwitchSub {\n\tuser_name: string;\n\tuser_id: string;\n}\n\nimport GpioDebug from \"./debug-tools\"\n\nlet Gpio = GpioDebug;\n\nlet WATER_RATE = 1;\nlet BUCKET_VOLUME = 1;\nlet DOLLAR_GOAL = 1;\nlet TIME_PER_DOLLAR = BUCKET_VOLUME / (WATER_RATE * DOLLAR_GOAL);\nconst MS_PER_S = 1000.0;\n\nconst eventQueue = new Queue<Donation>();\nlet solenoidCtrl = new Gpio(Number(process.env[\"MOONDUNK_PIN\"]), 'out');\n\nexport default async function (nodecg: NodeCG.ServerAPI) {\n\tnodecg.log.info(\"Hello, from your bundle's extension!\");\n\tnodecg.log.info(\"I'm where you put all your server-side code.\");\n\tnodecg.log.info(\n\t\t`To edit me, open \"${__filename.replace(\n\t\t\t'build/extension',\n\t\t\t'src/extension',\n\t\t)}\" in your favorite text editor or IDE.`,\n\t);\n\tawait load(nodecg);\n\n\n\tconst queuedDonationsRep = nodecg.Replicant<Array<Donation>>(\"queueddonations\");\n\tconst usedDonationIdsRep = nodecg.Replicant<Array<string>>(\"useddonationids\");\n\tconst twitchSubsRep = nodecg.Replicant<Array<TwitchSub>>(\"twitchsubs\");\n\tconst fakeTotalRep = nodecg.Replicant<number>(\"faketotal\");\n\n\tconst allDonationsRep = nodecg.Replicant<Array<Donation>>(\"alldonations\", \"tiltify-nodecg\");\n\tallDonationsRep.on('change', (newValue: Array<Donation> | undefined, oldValue: Array<Donation> | undefined) => {\n\t\tconst usedSet = new Set(usedDonationIdsRep.value ?? []);\n\n\t\tfor (const donation of newValue ?? []) {\n\t\t\tif (usedSet.has(donation.id)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\teventQueue.enqueue(donation);\n\t\t\tqueuedDonationsRep.value = [...eventQueue];\n\t\t}\n\t});\n\n\tnodecg.listenFor(\"subscription\", \"twitch-bundle\", (message: TwitchSub) => {\n\t\tif (twitchSubsRep.value == undefined) {\n\t\t\ttwitchSubsRep.value = [message];\n\t\t} else {\n\t\t\ttwitchSubsRep.value = [...twitchSubsRep.value, message];\n\t\t}\n\t});\n\n\tnodecg.listenFor(\"manualdono\", (manualDono: Donation) => {\n\t\tconsole.log(\"i was here\")\n\t\teventQueue.enqueue(manualDono);\n\t\tqueuedDonationsRep.value = [...eventQueue];\n\t})\n\n\t/*\n\tlet delay = 0;\n\tsetInterval(async () => {\n\t\tlet a: Donation = {\n\t\t\tid: randomUUID(),\n\t\t\tdonor_name: randomUUID(),\n\t\t\tamountDisplay: 25.10,\n\t\t}\n\t\tawait sleep(delay * 1000);\n\t\tdelay = (delay + 1 )% 20 ;\n\t\teventQueue.enqueue(a);\n\t\tqueuedDonationsRep.value = [...eventQueue];\n\t\tif (fakeTotalRep?.value == undefined) {\n\t\t\tfakeTotalRep.value = a.amountDisplay;\n\t\t} else {\n\t\t\tfakeTotalRep.value += a.amountDisplay;\n\t\t}\n\t}, 3000);\n\n\tlet delay2 = 0;\n\tsetInterval(async () => {\n\t\tlet b: TwitchSub = {\n\t\t\tuser_id: randomUUID(),\n\t\t\tuser_name: randomUUID(),\n\t\t};\n\t\tawait sleep(delay2 * 1000);\n\t\tdelay2 = (delay2 + 1 )% 20 ;\n\t\tif (twitchSubsRep?.value == undefined) {\n\t\t\ttwitchSubsRep.value = [b];\n\t\t} else {\n\t\t\ttwitchSubsRep.value = [...twitchSubsRep.value, b]\n\t\t}\n\t}, 3000);\n\t*/\n\n\tprocessDunks(queuedDonationsRep, usedDonationIdsRep);\n};\n\nasync function processDunks(queuedDonationsRep: NodeCG.ServerReplicant<Array<Donation>>, usedDonationIdsRep: NodeCG.ServerReplicant<Array<string>>) {\n\twhile (true) {\n \t\tif (eventQueue.size() != 0) {\n    \t\tconst donation = eventQueue.peek();\n \t    \tawait processNext(donation);\n\t\t\t// event to update queue replicant\n    \t\teventQueue.dequeue();\n\t\t\tqueuedDonationsRep.value = [...eventQueue];\n\t\t\tusedDonationIdsRep.value = [...usedDonationIdsRep?.value ?? [], donation.id];\n \t\t}\n\t\tawait sleep(100);\n\t}\n}\n\nasync function processNext(event: Donation) {\n\tif (event == undefined) {\n\t\treturn;\n\t}\n\n    const amountUsd = event.amountDisplay;\n    const duration = amountUsd * TIME_PER_DOLLAR;\n    const msg = `\\n${event.donor_name} donated $${amountUsd} USD for ${duration} seconds of water`;\n    console.log(msg);\n\n\n    // set pin low (water flows)\n    solenoidCtrl.writeSync(0);\n\n    const dispenseMsgr = (time: number) => {\n        process.stdout.clearLine(0);\n        process.stdout.cursorTo(0);\n        process.stdout.write(`Dispensing water: ${time.toFixed(2)}`);\n\t\t// todo: update the timer on the replicant (maybe not necessary. can use two timers fine)\n    }\n    await timer(duration, dispenseMsgr, 0.1);\n    console.log()\n\n    // set pin high (water stops)\n    solenoidCtrl.writeSync(1);\n    console.log(`Water for ${event.donor_name} finished dispensing`);\n}\n\nasync function timer(time: number, fn: (time: number) => void, step: number) {\n    fn(time);\n    while (time > 0.0001) {\n        await new Promise(r => setTimeout(r, step * MS_PER_S));\n        return await timer(Math.max(time - step, 0.0), fn, step);\n    }\n}\n\nasync function sleep(time: number) {\n\treturn new Promise(r => setTimeout(r, time));\n}\n\nasync function load(nodecg: NodeCG.ServerAPI) {\n\tWATER_RATE = nodecg.bundleConfig[\"MOONDUNK_RATE\"] as number ?? 1; // estimated gallons_per_second\n\tBUCKET_VOLUME = nodecg.bundleConfig[\"MOONDUNK_VOLUME\"] as number ?? 1; // estemated gallons\n\tDOLLAR_GOAL = nodecg.bundleConfig[\"MOONDUNK_GOAL\"] as number ?? 1; // estimated USD per dunk\n\tTIME_PER_DOLLAR = BUCKET_VOLUME / (WATER_RATE * DOLLAR_GOAL);\n\tif (!(nodecg.bundleConfig[\"MOONDUNK_DEBUG\"] ?? false)) {\n\t\ttry{\n\t\t\tconst GpioActual = await import(\"onoff\");\n\t\t\t// @ts-ignore\n\t\t\tGpio = GpioActual.Gpio\n\t\t} catch (e) {\n\t\t\tconsole.log(\"could not use onoff library\")\n\t\t}\n\t}\n\tsolenoidCtrl = new Gpio(nodecg.bundleConfig[\"MOONDUNK_PIN\"] as number, 'out');\n}\n","export default class Gpio {\n    pin: number;\n    type: string;\n    status: number; \n    constructor(pin: number, type: string) {\n        this.pin = pin;\n        this.type = type;\n        this.status = 0;\n    }\n\n    writeSync(status: number) {\n        console.log(`Debug only.  This is only simulating pin control: Pin ${this.pin} is being set from ${this.status} to ${status}`);\n        this.status = status;\n    }\n}\n"],"names":["Object","e","Symbol","Gpio","pin","type","t","writeSync","status","console","WATER_RATE","BUCKET_VOLUME","DOLLAR_GOAL","TIME_PER_DOLLAR","eventQueue","Queue","solenoidCtrl","Number","process","nodecg","queuedDonationsRep","usedDonationIdsRep","twitchSubsRep","__filename","_nodecg_bundleConfig_MOONDUNK_RATE","_nodecg_bundleConfig_MOONDUNK_VOLUME","_nodecg_bundleConfig_MOONDUNK_GOAL","_nodecg_bundleConfig_MOONDUNK_DEBUG","GpioActual","allDonationsRep","newValue","oldValue","usedSet","Set","_usedDonationIdsRep_value","_iteratorError","donation","message","undefined","manualDono","event","amountUsd","duration","timer","time","fn","step","Promise","r","setTimeout","Math"],"mappings":"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"}